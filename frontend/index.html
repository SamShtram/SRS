<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Shelter Finder</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Search box */
        #searchBox {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: white;
            padding: 10px 14px;
            border-radius: 8px;
            width: 420px;
            box-shadow: 0px 2px 6px rgba(0,0,0,0.25);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #searchBox input {
            flex: 1;
            padding: 6px;
            border: none;
            outline: none;
            font-size: 14px;
        }

        #searchBox button {
            padding: 6px 10px;
            cursor: pointer;
        }

        /* Use My Location button */
        #locateBtn {
            background: #0066ff;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        #locateBtn:hover {
            background: #0050cc;
        }

        /* Results sidebar */
        #resultsPanel {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 300px;
            max-height: 70%;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 10px;
            display: none;
            z-index: 9999;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            font-family: Arial;
        }

        .resultItem {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .resultItem:hover {
            background: #f0f0f0;
        }

        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 9999;
            display: none;
            font-size: 16px;
            font-family: Arial;
        }

        .directionsBtn {
            margin-top: 6px;
            padding: 5px 10px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .directionsBtn:hover {
            background: #004dcc;
        }

    </style>
</head>

<body>

    <!-- Search UI -->
    <div id="searchBox">
        <input id="addressInput" type="text" placeholder="Search city or address..." />
        <button onclick="searchAddress()">Search</button>
        <button id="locateBtn" onclick="useMyLocation()">üìç</button>
    </div>

    <div id="resultsPanel"></div>
    <div id="loading">Loading...</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>

        let userLocation = null;
        let currentRoute = null;

    const shelterIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -28]
    });

    const map = L.map('map').setView([41.0, -75.0], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let shelterMarkers = [];

    function clearMarkers() {
        shelterMarkers.forEach(m => map.removeLayer(m));
        shelterMarkers = [];
    }

    async function geocode(address) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.length) return null;
        return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    async function fetchShelters(lat, lon) {
        const backendUrl = `http://127.0.0.1:8000/nearest?lat=${lat}&lon=${lon}&limit=10`;
        console.log("Backend request:", backendUrl);

        const response = await fetch(backendUrl);
        if (!response.ok) {
            console.error("Backend error:", await response.text());
            alert("Backend error ‚Äî check terminal.");
            return null;
        }

        return await response.json();
    }

    async function searchAddress() {
    const address = document.getElementById("addressInput").value;
    if (!address) return;

    // Show loading popup
    document.getElementById("loading").style.display = "block";

    // Geocode with Nominatim
    const loc = await geocode(address);
    if (!loc) {
        alert("Address not found.");
        document.getElementById("loading").style.display = "none";
        return;
    }

    // Build backend request
    const backendUrl = `http://127.0.0.1:8000/nearest?lat=${loc.lat}&lon=${loc.lon}&limit=10`;
    console.log("Backend request:", backendUrl);

    // Fetch shelters from backend API
    const response = await fetch(backendUrl);

    if (!response.ok) {
        console.error("Backend error:", await response.text());
        alert("Backend error ‚Äî check terminal.");
        document.getElementById("loading").style.display = "none";
        return;
    }

    const shelters = await response.json();

    // Show results on map + sidebar
    userLocation = { lat: loc.lat, lon: loc.lon };
    await displayShelters(loc.lat, loc.lon, shelters);

    // Done loading
    document.getElementById("loading").style.display = "none";
}


    async function useMyLocation() {
        document.getElementById("loading").style.display = "block";

        if (!navigator.geolocation) {
            alert("Geolocation not supported.");
            return;
        }

        navigator.geolocation.getCurrentPosition(async pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            userLocation = { lat, lon};

            map.setView([lat, lon], 13);
            await displayShelters(lat, lon);

        }, err => {
            alert("Failed to get location.");
            console.error(err);
            document.getElementById("loading").style.display = "none";
        });
    }

    async function displayShelters(lat, lon, shelters = null) {

    // If shelters were not provided, fetch them from backend
    if (!shelters) {
        shelters = await fetchShelters(lat, lon);
    }

    if (!shelters) {
        document.getElementById("loading").style.display = "none";
        return;
    }

    map.setView([lat, lon], 13);

    clearMarkers();

    const panel = document.getElementById("resultsPanel");
    panel.innerHTML = "";
    panel.style.display = "block";

    shelters.forEach((s, i) => {
        const marker = L.marker([s.lat, s.lon], { icon: shelterIcon }).addTo(map);

        marker.bindPopup(`
            <b>${s.name}</b><br>
            Distance: ${s.distance_km} km<br>
            Capacity: ${s.capacity}<br>
            Risk Level: ${s.risk_level}
        `);

        shelterMarkers.push(marker);

        const item = document.createElement("div");
        item.className = "resultItem";
        item.innerHTML = `
            <b>${i + 1}. ${s.name}</b><br>
            ${s.distance_km} km away<br>
            Capacity: ${s.capacity}<br>
            <button class="directionsBtn">Get Directions</button>
        `;

        item.onclick = () => {
            map.setView([s.lat, s.lon], 15);
            marker.openPopup();
        };

        panel.appendChild(item);

        const btn = item.querySelector(".directionsBtn");
        btn.onclick = (e) => {
            e.stopPropagation(); // prevent triggering item.onclick

        if (!userLocation) {
            alert("No starting location available. Use search or 'Use My Location'.");
            return;
        }

        routeToShelter(
            userLocation.lat, userLocation.lon,
            s.lat, s.lon
        );
    };
    });

    document.getElementById("loading").style.display = "none";
}

    async function routeToShelter(startLat, startLon, destLat, destLon) {
    // Remove old route if one exists
    if (currentRoute) {
        map.removeLayer(currentRoute);
        currentRoute = null;
    }

    const url =
      `https://router.project-osrm.org/route/v1/driving/${startLon},${startLat};${destLon},${destLat}?overview=full&geometries=geojson`;

    const res = await fetch(url);
    const data = await res.json();

    if (!data.routes || !data.routes.length) {
        alert("Failed to load route.");
        return;
    }

    const route = data.routes[0].geometry;

    currentRoute = L.geoJSON(route, {
        style: { color: "blue", weight: 5 }
    }).addTo(map);

    map.fitBounds(currentRoute.getBounds(), { padding: [50, 50] });
}


</script>


</body>
</html>
